<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  
  <!-- AlpineJS -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <title>Curesdev Tokenizer</title>
  
  
  <!-- Curesdev tokenizer -->
  <script>
    function drawLines(id, bf, color) {
      var c = document.getElementById(id);
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, c.width, c.height);
      ctx.fillStyle = color;
      W = 2000;
      H = 50;
      bf.forEach(function (bit, i) {
        if (bit) {
          ctx.fillRect(W/bf.length*i, 0, W/bf.length, H);
        }
      });
    }
    
    function drawBloomFilters(l, eps) {
      // Array of random booleans of length l
      let bitmask = [];
      for (var i = 0; i < l; i++) {
        bitmask.push(Math.random() < 0.5);
      }
      drawLines("bloomFilter", bitmask, "#78716c");
      
      let flipped = [];
      // Differential privacy
      for (var i = 0; i < l; i++) {
        let flip = Math.random() < (1 / (1 + Math.exp(eps)));
        flipped.push(flip);
        if (flip) {
          bitmask[i] = !bitmask[i];
        }
      }
      drawLines("flippedBits", flipped, "#dc2626");
      drawLines("diffusedBF", bitmask, "#0284c7");
    }

  </script>
  
  <style>
    body {
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
    }
    
    h1 {
      margin-bottom: 30px;
    }
    
    canvas {
      border: 1px solid #000;
    }

    .row, .card {
      margin-bottom: 40px;
    }
  </style>
  
</head>


<script>
  function SHA256(s){

 


    var chrsz   = 8;


    var hexcase = 0;

 


    function safe_add (x, y) {


        var lsw = (x & 0xFFFF) + (y & 0xFFFF);


        var msw = (x >> 16) + (y >> 16) + (lsw >> 16);


        return (msw << 16) | (lsw & 0xFFFF);


    }

 


    function S (X, n) { return ( X >>> n ) | (X << (32 - n)); }


    function R (X, n) { return ( X >>> n ); }


    function Ch(x, y, z) { return ((x & y) ^ ((~x) & z)); }


    function Maj(x, y, z) { return ((x & y) ^ (x & z) ^ (y & z)); }


    function Sigma0256(x) { return (S(x, 2) ^ S(x, 13) ^ S(x, 22)); }


    function Sigma1256(x) { return (S(x, 6) ^ S(x, 11) ^ S(x, 25)); }


    function Gamma0256(x) { return (S(x, 7) ^ S(x, 18) ^ R(x, 3)); }


    function Gamma1256(x) { return (S(x, 17) ^ S(x, 19) ^ R(x, 10)); }

 


    function core_sha256 (m, l) {


        var K = new Array(0x428A2F98, 0x71374491, 0xB5C0FBCF, 0xE9B5DBA5, 0x3956C25B, 0x59F111F1, 0x923F82A4, 0xAB1C5ED5, 0xD807AA98, 0x12835B01, 0x243185BE, 0x550C7DC3, 0x72BE5D74, 0x80DEB1FE, 0x9BDC06A7, 0xC19BF174, 0xE49B69C1, 0xEFBE4786, 0xFC19DC6, 0x240CA1CC, 0x2DE92C6F, 0x4A7484AA, 0x5CB0A9DC, 0x76F988DA, 0x983E5152, 0xA831C66D, 0xB00327C8, 0xBF597FC7, 0xC6E00BF3, 0xD5A79147, 0x6CA6351, 0x14292967, 0x27B70A85, 0x2E1B2138, 0x4D2C6DFC, 0x53380D13, 0x650A7354, 0x766A0ABB, 0x81C2C92E, 0x92722C85, 0xA2BFE8A1, 0xA81A664B, 0xC24B8B70, 0xC76C51A3, 0xD192E819, 0xD6990624, 0xF40E3585, 0x106AA070, 0x19A4C116, 0x1E376C08, 0x2748774C, 0x34B0BCB5, 0x391C0CB3, 0x4ED8AA4A, 0x5B9CCA4F, 0x682E6FF3, 0x748F82EE, 0x78A5636F, 0x84C87814, 0x8CC70208, 0x90BEFFFA, 0xA4506CEB, 0xBEF9A3F7, 0xC67178F2);


        var HASH = new Array(0x6A09E667, 0xBB67AE85, 0x3C6EF372, 0xA54FF53A, 0x510E527F, 0x9B05688C, 0x1F83D9AB, 0x5BE0CD19);


        var W = new Array(64);


        var a, b, c, d, e, f, g, h, i, j;


        var T1, T2;

 


        m[l >> 5] |= 0x80 << (24 - l % 32);


        m[((l + 64 >> 9) << 4) + 15] = l;

 


        for ( var i = 0; i<m.length; i+=16 ) {


            a = HASH[0];


            b = HASH[1];


            c = HASH[2];


            d = HASH[3];


            e = HASH[4];


            f = HASH[5];


            g = HASH[6];


            h = HASH[7];

 


            for ( var j = 0; j<64; j++) {


                if (j < 16) W[j] = m[j + i];


                else W[j] = safe_add(safe_add(safe_add(Gamma1256(W[j - 2]), W[j - 7]), Gamma0256(W[j - 15])), W[j - 16]);

 


                T1 = safe_add(safe_add(safe_add(safe_add(h, Sigma1256(e)), Ch(e, f, g)), K[j]), W[j]);


                T2 = safe_add(Sigma0256(a), Maj(a, b, c));

 


                h = g;


                g = f;


                f = e;


                e = safe_add(d, T1);


                d = c;


                c = b;


                b = a;


                a = safe_add(T1, T2);


            }

 


            HASH[0] = safe_add(a, HASH[0]);


            HASH[1] = safe_add(b, HASH[1]);


            HASH[2] = safe_add(c, HASH[2]);


            HASH[3] = safe_add(d, HASH[3]);


            HASH[4] = safe_add(e, HASH[4]);


            HASH[5] = safe_add(f, HASH[5]);


            HASH[6] = safe_add(g, HASH[6]);


            HASH[7] = safe_add(h, HASH[7]);


        }


        return HASH;


    }

 


    function str2binb (str) {


        var bin = Array();


        var mask = (1 << chrsz) - 1;


        for(var i = 0; i < str.length * chrsz; i += chrsz) {


            bin[i>>5] |= (str.charCodeAt(i / chrsz) & mask) << (24 - i%32);


        }


        return bin;


    }

 


    function Utf8Encode(string) {


        string = string.replace(/\r\n/g,"\n");


        var utftext = "";

 


        for (var n = 0; n < string.length; n++) {

 


            var c = string.charCodeAt(n);

 


            if (c < 128) {


Name

1. Sanitize
victor
Remove accents
Remove non-letters
Lowercase

2. q-grams
vi ic ct to or
q = 2 


            else {


                utftext += String.fromCharCode((c >> 12) | 224);


                utftext += String.fromCharCode(((c >> 6) & 63) | 128);


                utftext += String.fromCharCode((c & 63) | 128);


            }

 


        }

 


        return utftext;


    }

 


    function binb2hex (binarray) {


        var hex_tab = hexcase ? "0123456789ABCDEF" : "0123456789abcdef";


        var str = "";


        for(var i = 0; i < binarray.length * 4; i++) {


            str += hex_tab.charAt((binarray[i>>2] >> ((3 - i%4)*8+4)) & 0xF) +


            hex_tab.charAt((binarray[i>>2] >> ((3 - i%4)*8  )) & 0xF);


        }


        return str;


    }

 


    s = Utf8Encode(s);


    return binb2hex(core_sha256(str2binb(s), s.length * chrsz));

 

}
</script>

<script>

  let data = {
    l: 500,
    eps: 2,
    q: 2,

    sanitizeRemoveAccents: true,
    sanitizeRemoveNonLetters: true,
    sanitizeLowercase: true,

    name1: 'VÃ­ctor',

    sanitize(s) {
      if (this.sanitizeRemoveAccents) {
        s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }
      if (this.sanitizeRemoveNonLetters) {
        s = s.replace(/[^a-zA-Z]/gi, '');
      }
      if (this.sanitizeLowercase) {
        s = s.toLowerCase();
      }
      return s;
    },
    qgrams(s) {
      let q = parseInt(this.q);
      if (s.length <= q) {
        return [s];
      }
      var result = [];
      for (var i = 0; i < s.length - q + 1; i++) {
        result.push(s.slice(i, i + q));
      }
      return result;
    },
    qgrams_html(qgrams) {
      this.bf1();
      return qgrams.map(qgram => `<span class="badge bg-primary" style="margin-right: 10px">${qgram}</span>`).join(' ');
    },
    bloomFilter(chunks) {
      let bf = new Array(this.l).fill(false);
      chunks.forEach(async chunk => {
        for (var i = 0; i < Math.round(Math.log(2)*this.l/chunks.length); i++) {
          bf[parseInt(SHA256(chunk + "#" + i), 16) % this.l] = true;
        }
      });
      let flipped = [];
      for (var i = 0; i < this.l; i++) {
        let flip = Math.random() < (1 / (1 + Math.exp(this.eps)));
        flipped.push(flip);
        if (flip) {
          bf[i] = !bf[i];
        }
      }
      drawLines("bf1", bf, "#78716c");
      drawLines("flippedBits", flipped, "#dc2626");
      drawLines("diffusedBF", bf, "#0284c7");
    },
    
    sanitized1() {
      return this.sanitize(this.name1);
    },
    qgrams1() {
      return this.qgrams_html(this.qgrams(this.sanitized1()));
    },
    bf1() {
      let bf = this.bloomFilter(this.qgrams(this.sanitized1()));
    },

    diffused1: '',
    showDetails1: false,
  };
</script>

<body x-data="data">
<div class="container">
  <h1>Curesdev Tokenizer</h1>
  
  <div class="card border-primary">
    <div class="card-header bg-primary text-white">
      PII 1
    </div>
    <div class="card-body">

      <div class="row">
        <div class="col">
          <label for="name1" class="form-label"><b>Name</b></label>
          <input type="name" class="form-control" id="name1" x-model="name1">
        </div>
      </div>
      
      <div class="collapse" id="details1">
        <div class="row">
          <div class="col-8">
            <p><b>1. Sanitize</b></p>
            <h5><span x-text="sanitized1()" class="badge bg-secondary"></span></h5>
          </div>
          <div class="col">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" x-model="sanitizeRemoveAccents">
              <label class="form-check-label" for="flexCheckDefault">
                Remove accents
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="flexCheckChecked"  x-model="sanitizeRemoveNonLetters">
              <label class="form-check-label" for="flexCheckChecked">
                Remove non-letters
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="flexCheckChecked" x-model="sanitizeLowercase">
              <label class="form-check-label" for="flexCheckChecked">
                Lowercase
              </label>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-8">
            <p><b>2. q-grams</b></p>
            <h5 x-html="qgrams1()"></h5>
          </div>
          <div class="col">
            <label for="q-range" class="form-label">
              q =
              <span x-text="q"></span>
            </label>
            <input type="range" class="form-range" id="q-range" min="2" max="5" x-model="q">
          </div>
        </div>

        <div class="row">
          <p><b>3. Bloom filter</b></p>
          <div class="col-8">
            <canvas id="bf1" width="2000" height="50" style="width: 100%; height: 50px"></canvas>
          </div>
          <div class="col">
            <label for="l-range" class="form-label">
              length =
              <span x-text="l"></span>
            </label>
            <input type="range" class="form-range" id="l-range" min="10" max="1024" x-model="l">
          </div>
        </div>
        
        <div class="row">
          <p><b>4. Differential privacy</b></p>
          <div class="col-8">
            <canvas id="flippedBits" width="2000" height="50" style="width: 100%; height: 50px"></canvas>
          </div>
          <div class="col">
            <label for="eps-range" class="form-label">
              &epsilon; =
              <span x-text="eps"></span>
              (p<sub>flip</sub> = <span x-text="parseFloat(100 / (1 + Math.exp(eps))).toFixed(2)"></span>%)
            </label>
            <input type="range" class="form-range" id="eps-range" min="0" max="10" x-model="eps">
          </div>
        </div>
      </div>

      <div class="row">
        <p><b>Token</b></p>
        <div class="col-8">
          <canvas id="diffusedBF" width="2000" height="50" style="width: 100%; height: 50px"></canvas>
        </div>
        <div class="col">
          <a class="btn btn-primary" data-bs-toggle="collapse" href="#details1" role="button" aria-expanded="false" aria-controls="details1" x-text="showDetails1 ? 'Hide details' : 'Show details'" @click="showDetails1 = !showDetails1">
          </a>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

</body>
</html>
